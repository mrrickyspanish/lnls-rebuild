import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { extractYouTubeId } from "@/lib/youtube/id";

// Use a SERVICE ROLE key here so RLS doesn't block writes
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const YT_KEY = process.env.YOUTUBE_API_KEY!;
const CHANNEL_ID = process.env.YOUTUBE_CHANNEL_ID || "UCxxxxxxxxxxxxxxxxxxxxxx"; // set your LNLS channel id in env

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE, {
  auth: { persistSession: false, autoRefreshToken: false },
});

type YouTubeItem = {
  id: { videoId?: string };
  snippet?: {
    title?: string;
    description?: string;
    publishedAt?: string;
    thumbnails?: { high?: { url?: string } };
  };
};

export async function GET() {
  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE || !YT_KEY || !CHANNEL_ID) {
    return NextResponse.json({ ok: false, error: "Missing env vars" }, { status: 500 });
  }

  // Fetch recent uploads (Search API)
  const params = new URLSearchParams({
    key: YT_KEY,
    part: "snippet",
    channelId: CHANNEL_ID,
    maxResults: "50",
    order: "date",
    type: "video",
  });

  const res = await fetch(`https://www.googleapis.com/youtube/v3/search?${params.toString()}`);
  if (!res.ok) {
    const text = await res.text();
    return NextResponse.json({ ok: false, error: `YouTube API: ${res.status} ${text}` }, { status: 502 });
  }
  const json = (await res.json()) as { items?: YouTubeItem[] };

  const rows =
    (json.items || [])
      .map((it) => {
        const videoId = it.id?.videoId || null;
        if (!videoId) return null;
        const title = it.snippet?.title || "(no title)";
        const desc = it.snippet?.description || null;
        const publishedAt = it.snippet?.publishedAt || new Date().toISOString();
        const source_url = `https://www.youtube.com/watch?v=${videoId}`;
        const image_url =
          it.snippet?.thumbnails?.high?.url || `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;

        return {
          title,
          summary: desc,
          source: "YouTube",
          source_url,
          image_url,
          published_at: publishedAt,
          content_type: "video" as const,
          video_id: videoId,
        };
      })
      .filter(Boolean) as any[];

  if (!rows.length) {
    return NextResponse.json({ ok: true, upserted: 0, skipped: 0, reason: "no items" });
  }

  // Upsert on normalized key: video_id
  // (Relies on the unique index you created: ai_news_video_unique_by_video_id)
  const { data, error } = await supabase
    .from("ai_news_stream")
    .upsert(rows, { onConflict: "video_id", ignoreDuplicates: false });.select()

  if (error) {
    return NextResponse.json({ ok: false, error }, { status: 500 });
  }

  return NextResponse.json({ ok: true, upserted: data?.length ?? 0 });
}
