import BentoGrid from "@/components/home/BentoGrid";
import { getNewsStream } from "@/lib/supabase/client";
import { client } from "@/sanity/lib/client";
import { getLatestEpisode } from "@/lib/podcast/spreaker";
import { selectHero, isYouTube } from "@/lib/heroSelector";

export const revalidate = 60;

type SanityContent = {
  _id: string;
  _type: "article" | "episode" | "clip";
  title: string;
  slug?: { current: string };
  excerpt?: string;
  mainImage?: { asset: { url: string } };
  thumbnailUrl?: string;
  publishedAt?: string;
  source?: string;
  externalUrl?: string;
  videoUrl?: string;
};

export default async function HomePage() {
  try {
    const supabaseData = await getNewsStream(30);

    const [articles, episodes, clips, latestPodcast] = await Promise.all([
      client.fetch<SanityContent[]>(
        `*[_type == "article"] | order(publishedAt desc)[0...15]{
          _id,_type,title,slug,excerpt,
          "mainImage": mainImage.asset->url,
          publishedAt,source,externalUrl
        }`
      ),
      client.fetch<SanityContent[]>(
        `*[_type == "episode"] | order(publishedAt desc)[0...10]{
          _id,_type,title,slug,excerpt,
          "mainImage": mainImage.asset->url,
          publishedAt,source
        }`
      ),
      client.fetch<SanityContent[]>(
        `*[_type == "clip"] | order(publishedAt desc)[0...10]{
          _id,_type,title,videoUrl,thumbnailUrl,
          publishedAt,source
        }`
      ),
      getLatestEpisode(),
    ]);

    const supabaseItems = (supabaseData || []).map((item: any) => ({
      id: String(item.id),
      title: item.title,
      excerpt: item.excerpt || undefined,
      image_url: item.image_url || null,
      content_type: item.content_type || "article",
      source: item.source || undefined,
      source_url: item.source_url || null,
      published_at: item.published_at || null,
    }));

    const sanityItems = [...articles, ...episodes, ...clips].map((item) => {
      let content_type: "article" | "podcast" | "video" = "article";
      if (item._type === "episode") content_type = "podcast";
      if (item._type === "clip") content_type = "video";

      return {
        id: item._id,
        title: item.title,
        excerpt: item.excerpt || undefined,
        image_url: item.mainImage || item.thumbnailUrl || null,
        content_type,
        source: item.source || "LNLS",
        source_url:
          item.externalUrl ||
          item.videoUrl ||
          (item.slug ? `/news/${item.slug.current}` : null),
        published_at: item.publishedAt || null,
      };
    });

    // Merge & sort newest â†’ oldest
    const merged = [...supabaseItems, ...sanityItems].sort((a, b) => {
      const da = a.published_at ? new Date(a.published_at).getTime() : 0;
      const db = b.published_at ? new Date(b.published_at).getTime() : 0;
      return db - da;
    });

    // Find latest video from merged content
    const latestVideo = merged.find((x) => {
      const ct = (x.content_type || "").toLowerCase();
      return ct === "video" || isYouTube(x.source_url);
    });

    // Select Box 1 and Box 2 using hero selector
    const heroSelection = selectHero({
      podcast: latestPodcast,
      video: latestVideo || null,
    });

    return (
      <main className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 py-8 md:py-12">
        {/* HERO HEADER visuals (no layout change) */}
        <div className="relative max-w-[1440px] mx-auto px-4 md:px-6 lg:px-8 mb-8">
          <div className="hero-ambient" aria-hidden></div>
          <span className="hero-twinkle t1" aria-hidden></span>
          <span className="hero-twinkle t2" aria-hidden></span>
          <span className="hero-twinkle t3" aria-hidden></span>

          <div className="text-center space-y-3">
            <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold hero-title-glow bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 via-indigo-300 to-cyan-200">
              Late Night Lake Show
            </h1>
            <p className="text-lg md:text-xl text-slate-400/90 max-w-2xl mx-auto">
              A modern hub for Lakers, NBA, tech &amp; entertainment
            </p>
          </div>
        </div>

        <BentoGrid
          box1={heroSelection.box1}
          box2={heroSelection.box2}
          items={merged}
        />
      </main>
    );
  } catch (error) {
    console.error("Error fetching content:", error);
    return (
      <main className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 py-20">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-white mb-4">Late Night Lake Show</h1>
          <p className="text-slate-400">Unable to load content. Please try again later.</p>
        </div>
      </main>
    );
  }
}